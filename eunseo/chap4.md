## 카프카 상세 개념 설명

4.1.1 적정 파티션 개수 
- 프로듀서 전송 데이터량 < 컨슈머 데이터 처리량 X 파티션 개수
- 메세지 키 사용할 경우 파티션 개수가 달라지면 이미 매칭된 파티션과 메세지 키의 매칭이 깨지고 전혀 다른 파티션에 데이터가 할당되므로 순서 보장 x 
  
4.1.2 토픽 정리 정책
```
cleanup.policy = delete -> 영구삭제 
               = compact -> 메세지 키 기준으로 오래된 데이터 삭제 
```

4.1.3 ISR(In-Sync-Replicas)
- 리더 파티션과 팔로워 파티션이 모두 싱크가 된 상태
- replica.lag.time.max.ms: 팔로워 파티션이 데이터를 복제하는지 확인하는 주기

  ⇒ 데이터를 가져가지 않으면 문제가 생겼다고 판단하고 ISR 그룹에서 제외

 
- ISR 그룹: 팔로워 파티션은 리더로 선출될 자격을 가진다.
- ISR로 묶이지 못한 팔로워 파티션: 리더로 선출될 자격이 없다.

⇒ unclean.leader.election.enable = true로 설정하면 ISR로 묶이지 못한 팔로워 파티션도 리더로 선출할 수 있다.

 
```
unclean.leader.election.enable 옵션
일부 데이터가 유실되어도 무중단 운영이 필요한 경우 → true
데이터가 유실되면 안되는 경우 → false
```
 

## 프로듀서 
#### 4.2.1 acks 옵션
```
acks=0
프로듀서가 리더 파티션으로 데이터를 전송하고 데이터 저장 여부를 응답 값으로 받지 않는다.
데이터 전송 속도는 가장 빠르기 때문에 신뢰성보다 전송 속도가 중요할 때 사용한다.
 ```
```
acks=1
프로듀서는 리더 파티션에만 정상적으로 데이터가 적재되었는지 확인한다.
리더 파티션에 한해서만 적재될 때까지 재시도할 수 있다.
팔로워 파티션이 데이터를 복제하기 직전에 장애가 발생하면 데이터가 유실될 수 있다.
```
```
acks=all (or -1)
프로듀서가 리더와 팔로워 파티션(ISR 그룹)에 모두 정상 적재되었는지 확인한다.
min.insync.replicas: 프로듀서가 데이터 적재를 확인할 최소 ISR 그룹의 파티션 개수
최소 2로 설정해야 all로 설정하는 의미가 있다.
브로커 개수 미만으로 꼭 설정하도록 한다.
 ```

가장 안정적인 설정 방법
- 토픽 복제 개수 = 3
- min.insync.replicas = 2
- acks = all

#### 4.2.2 멱등성 프로듀서
- enable.idempotence 옵션 = true --> 데이터를 브로커에 전달할 때 PID(Producer unique ID)와 시퀀스 넘버를 함께 전달  -> PID와 시퀀스 넘버 확인하여 동일한 메세지는 적재하지 않는다.
- 애플리케이션을 재시작하면 PID가 달라진다.
- 정확히 한번 적재하기 위해서는 retries = Integer.MAX_VALUE 설정, acks = all로 설정된다

#### 4.2.3 트랜잭션 프로듀서
- 다수의 파티션에 데이터를 저장할 경우 모든 데이터에 대해 동일한 원자성을 만족시키기 위해 사용
- enable.idempotence = true, transactional.id를 임의의 String값으로 정의, 컨슈머 isolation.level = read_committed로 설정할 경우 컨슈머는 트랜잭션으로 처리 완료된 데이터만 쓰고 읽게 된다. 
